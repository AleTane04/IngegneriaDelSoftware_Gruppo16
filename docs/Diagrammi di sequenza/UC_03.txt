@startuml
' Stile conforme alla Slide 13 (Diagrammi di Interazione)
skinparam style strictuml
skinparam sequenceArrowThickness 1.5
skinparam roundcorner 5
skinparam maxmessagesize 150
skinparam sequenceParticipant underline

' Definizione Partecipanti
actor "Bibliotecario" as User
participant ":LibriView" as View
participant ":LibriController" as Controller
participant ":Biblioteca" as Service

' --- INIZIO FLUSSO ---
Note over User, View : Il bibliotecario seleziona un libro dalla tabella

User -> View : Clicca su "Rimuovi"
activate View

    View -> Controller : handleRimuoviLibro()
    activate Controller

        ' Recupero del libro selezionato dalla UI
        Controller -> View : l = getLibroSelezionato()

        ' Richiesta al Service (Facade)
        Controller -> Service : rimuoviLibro(l)
        activate Service

            ' Verifica Vincolo (FC-5: Vincolo Cancellazione Libro)
            Note right of Service : Verifica prestiti attivi

            Service -> Service : n_prestiti = countPrestitiAttivi(l)

            alt libro in prestito (n_prestiti > 0)
                ' Flusso Alternativo 2a
                Service --> Controller : throw LibroInPrestitoException
                Controller --> View : mostraErrore("Impossibile eliminare: copie in prestito")
            
            else nessun prestito (n_prestiti == 0)
                ' Flusso Principale
                
                ' Rimozione logica
                Service -> Service : listaLibri.remove(l)

                ' Persistenza (FC-1)
                Service -> Service : salvaLibri()
                
                Service --> Controller : conferma
                
                Controller --> View : rimuoviRigaTabella(l)
                View --> User : Mostra conferma rimozione
            end

        deactivate Service
    deactivate Controller
deactivate View

@enduml