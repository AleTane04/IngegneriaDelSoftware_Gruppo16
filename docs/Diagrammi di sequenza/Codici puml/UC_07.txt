@startuml
' Stile conforme alla Slide 13 (Diagrammi di Interazione)
skinparam style strictuml
skinparam sequenceArrowThickness 1.5
skinparam roundcorner 5
skinparam maxmessagesize 150
skinparam sequenceParticipant underline

' Definizione Partecipanti
actor "Bibliotecario" as User
participant ":UtentiView" as View
participant ":UtentiController" as Controller
participant ":Biblioteca" as Service
participant "u:Utente" as Utente

' --- INIZIO FLUSSO ---
Note over User, View : Il bibliotecario seleziona un utente dalla tabella

User -> View : Clicca su "Rimuovi"
activate View

    View -> Controller : handleRimuoviUtente()
    activate Controller

        ' Recupero dell'utente selezionato
        Controller -> View : u = getUtenteSelezionato()

        ' Chiamata al Service (Facade)
        Controller -> Service : rimuoviUtente(u)
        activate Service

            ' Verifica Vincolo (FC-7: Vincolo Cancellazione Utente)
            Note right of Service : Verifica prestiti attivi

            Service -> Utente : getPrestitiAttivi()
            activate Utente
            Utente --> Service : listaPrestiti
            deactivate Utente

            alt listaPrestiti non vuota
                ' Flusso Alternativo 2a
                Service --> Controller : throw UtenteHaPrestitiException
                Controller --> View : mostraErrore("Impossibile eliminare: utente ha prestiti attivi")
            
            else listaPrestiti vuota
                ' Flusso Principale
                
                ' Rimozione logica dalla lista
                Service -> Service : registroUtenti.remove(u)

                ' Persistenza (FC-1)
                Service -> Service : salvaUtenti()
                
                Service --> Controller : conferma
                
                ' Aggiornamento UI
                Controller -> View : rimuoviRigaTabella(u)
                View --> User : Mostra conferma rimozione
            end

        deactivate Service
    deactivate Controller
deactivate View

@enduml